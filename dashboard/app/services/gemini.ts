import { GoogleGenAI } from "@google/genai";

const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });

const QUESTIONS = {
  INFO: `En base a una serie de mensajes que te voy a pasar, deduce cual es el pa√≠s, la ciudad y la provincia del siguiente usuario. Adem√°s, en base al contenido de los mensajes, si consideras que las conversaciones denotan un claro inter√©s por lo que hacemos (somos una banda de m√∫sica, infiere si en base a todo lo que diga la persona podr√≠a considerarse un superfan, un fan o no muestra demasiado inter√©s) a√±ade la catalogaci√≥n "superfan", "fan" en un campo "typeUser". Devuelve √∫nicamente en una linea lo que consideres, en formato json {"country":, "state":, "city":, "typeUser":}. Te muestro un ejemplo:
      Ejemplo 1 (typeUser:"superfan"): 
      ['Jajjajajaja, vamos!!!','üî•','B noches üòò','Claro que si','Como me alegro','Ole!!','Estar√© atenta si!! Vais a tope‚ù§Ô∏è','Vamos!!!','Poneros a trabajar que la necesito jajajaj','O sea q en casita con mucha misica de fondo','Est√° todo bien üôåüèªüôåüèª pero lo vi jodido‚Ä¶ accidente de tr√°fico, mi ni√±o y mi marido. Pero est√°n bien','Adem√°s de m√∫sicazos sois un amor','Me ha dado un golpe la vida‚Ä¶ pero sigo con mucha musica! ‚ù§Ô∏è sois geniales!','Bravo chicos!!! üëèüëèüëè','üëè','Favorita, sorryüôåüèªüôåüèªüôåüèª','üëè','ü§£ü§£ü§£','A saber‚Ä¶ que me sorprendan!!! ü§£ü§£ü§£','üòÇ','ü§¶üèΩ‚Äç‚ôÄÔ∏è','Jajajaj‚Ä¶ buen dato','Os lo voy a recordar ‚Ä¶.ü§£ü§£ü§£','Jajajajaaj. Pues no tengo programaci√≥n de enero, pero si me pilla en mad fijo!!!','Jajajaja. Que detallazo!!! \n' +'Ya la he escuchado, y me encanta‚Ä¶ adem√°s soy bastante especial en temas de navidad. La hab√©is bordado. Y la tengo en mis listas. \n' +'A ver si os veo pronto, que me encantar√≠a volver a veros en Madrid . \n' +'Feliz navidad para vosotros tb. Y mejor a√±o. Claro que me encantar√° lo que est√° por venir. üíô hasta pronto','üëè','üî•','üëè','üëè','üëè','üëè','üëè','Fijo','Ser√° genial','Jajajaja','No estoy‚Ä¶ porque iba fijo','Me pilla fuera‚Ä¶ que pena‚Ä¶ vais como\nUn tiro‚Ä¶.üéâüéâ','üëè','üëè','A ver siiiii!!!','ü§£ü§£','Que bien, est√°is viento en popa!üéâüéâ','Enhorabuena!!!! üíô','üëè','!!','Lo dicho, mucha suerte','Pues estamos en contacto','En septiembre mis veo, tb me encantan','Ah sisiii','Me encant√≥ !!! Mucho, a ver si cuelgo alg√∫n v√≠deo','https://open.spotify.com/track/7xlkgRk0rDGHEpYtRKrrbc?si=sEES8L8OTw6kEDPrgzwG8Q','A FULL','Ya os dicho','üçªüçªüëèüëè','üôãüèΩ‚Äç‚ôÄÔ∏è','Aqui estoy','FULL','Ya se a quien me record√°is tb','Abrazooo!!','Os lo dir√© por aqu√≠','No soy mucho de eso, me da palillo, pero lo har√©','Jajajaj','Pero ma√±ana voy a intentarlo','Si plis.','Que cuando los vi la primera vez no los conoc√≠a nin di‚Ä¶ y el s√°bado 16000 en el Wizink','Os vais a hacer como viva Suecia','Jajajaja','Yo en Madrid estoy por trabajo','Venid a La Coru√±a','Me j‚Ä¶ no poder ir, pero os sigo y os ver√© fijo','Buff, pero tengo madrug√≥n el s√°bado','Jajajajaj','Pues igual si puedo ir ma√±ana','Oh, Que me confund√≠ con el n√∫mero de la Calleü§£ü§£ü§£','Pues no me acuerdo ahora donde os he escuchado, pero me flipais, no descarto ir el 29 a veros , pero a√∫n no lo s√© seguro , canci√≥n?? Enganchada a ATRAPADO EN EL TIEMPO.‚ù§Ô∏è, me record√°is a la sonrisa de Julia , os deseo lo\n' +'Mejor'
] => {country: "Espa√±a", state: "A Coru√±a", city: "A Coru√±a", typeUser: "superfan"}
 Ejemplo 2 (typeUser: "superfan"):
 ["Hola, pues v√≠ vuestra versi√≥n de zorra y me gust√≥ mucho, soy zorra y eurofan. Suerte chicos","Me record√°is a Arde Bogot√°","Seguro que es cuesti√≥n de tiempo que triunfeis, el bocaüëÑüëÇ funcionar√°","Tambi√©n son√°is a los Piratas en sus mejores √°lbumes","Yo soy muy rockera y a mis 3 hijos se lo he metido en vena, aunque la mayor se me ha descarrilado con el ≈îauw Alejandro üòÑ.Con 20  a√±os fu√≠ la primera punk en mi pueblo, ahora con 50 lo sigo disfrutando y bailando encima de las barras de los bares, contando los d√≠as para El Madcool üòÖ","Son√°is muy bien, muy limpio y sois muy j√≥venes, llegar√° vuestra recompensa si sois constantes y no perd√©is la ilusi√≥n","Oye me ha encantado hablar contigo este ratito,  nunca hab√≠a contestado a estas cosas de Instagram porque siempre he pensado que son circulares publicitarias.","Es chica, no tengo esperanza en ella, el mediano es muy fan de Acdc y la peque√±a es muy mocatriz le gustan los smashing Pumpkins. Me la llevo al Madcool a verlos ( y a dua lipa, pero eso no lo digo muy alto)üòÉ","La m√∫sica en directo es lo mejor. Yo voy a muchos conciertos y festivales, cuando mi hermana se queda con los ni√±os, es dif√≠cil conciliar cuando est√°s sola. Vivo en Le√≥n. Pero a veces voy a Madrid a ver a mi hermano y a mi sobrino","Eso estar√≠a bien","Joder! Parec√©is unos cr√≠os, yo 48 pero me siento veintea√±era üòÇ","Claro , o al gran caf√©, ah√≠ voy mucho, molan mucho los conciertos all√≠, al √∫ltimo que fui fue a la despedida de Havalina, acab√© llorando con Manolo, me di√≥ mucha pena","Si, son unos t√≠os muy majos, les sigo desde que ten√≠an pelo jajaja","Si, o a Asturias que subo una vez al mes a escuchar algo y a por sidras üòè","Me molan mucho Le√≥n Benavente, me los encuentro por el plaza de Gij√≥n, tambi√©n corizonas me flipan, el vacas es alucinante","Yo soy un poco grupie, siempre acabo pidiendo baquetas y hablando con los del grupo. La gente del rock es muy maja üòÅ","Fijo","Cuando veng√°is al norte avisarme, que all√≠ estar√© pidiendo la p√∫a üòÑ","En primera fila","Claro, siempre me Dan las peores, los pobres, tengo colecci√≥n pongo fecha y nombre del grupo! Bueno a los de Calavento se la guind√© (shhhh)","Si la bad guial mete üé∏  igual lo conseguimos","Nunca se fu√©","Aunque a mi hay grupos tontipop, que no los soporto aunque mueven masas","Joder, yo he tenido que aprender a perrear para poder bailar algo en las fiestas de verano üòÇ","Siii, donde est√© una buena cumbia jeje","Buen nombre para un grupo","Jajajajajajaj","Me desorino  jajajajaja no lo hab√≠a visto","Vaya Hit","Me lo apunto para mi lista de petardadas, cuando pincho mi nombre art√≠stico es Lady Faja. \nPongo de Mary trini a kortatu para fiestas y despedidas de solter@s üòÑ","Mi amigos esperan ansiosos a que haga mi performan cuando pincho y saco las plumas con este grandisimo tema","https://youtu.be/5KkUOvpePmM?si=NwbMATP2JRmYfNVv","Ahora es cuando me bloqueas üòÑ","A qu√© te dedicas a parte de la m√∫sica üé∂?","Eso s√≠ que es un cl√°sico jajajaja","Yo me llevo fatal con los aparatos electr√≥nicos y el ordenador lo estrellar√≠a un par de veces al d√≠a","Lo m√≠o son los dientes","Lo se, a m√≠ me putea hasta la lavadora","Trabajo con ultrasonidos y turbinas que me da√±an la c√≥clea  y estoy perdiendo audici√≥n","La mutua piensa que es por trabajar en la cl√≠nica, lo que no sabe es que siempre estoy cerca de un altavoz üîä","Tendr√© que hablar con mi contacto en La salvaje de Oviedo y en el gran caf√© a ver si puedo disfrutaros en directo","Yo pongo la sidra o la cecina, depende de donde sea el concierto","Hola! En este festival buscan bandas","Un üëã","Si, pregunto a ver","Os contactaran por instagram a ver si os cuadra lo que os ofrecen","Saludos","Y suerte"] => {country: "Espa√±a", state: "Le√≥n", city: "Le√≥n", typeUser: "superfan"}

 Ejemplo 3 (typeUser: "fan"):
 ["Hola. Gracias por escribir y por saludarme y gracias por hacer tan buena m√∫sica.  ¬øComo os conoc√≠? Pues una vez al mes me gusta escuchar cosas nuevas, descubrir grupos que para m√≠ eran desconocidos... Aparecisteis como sugerencia en Spotify, Youtube y en Instagram y os di una oportunidad y sorpresa!: me hab√©is gustado un mont√≥n. \n Existe una canci√≥n especial: atrapado en el tiempo, me parece un mensaje estupendo, una forma de vida, una historia personal muy larga...y porque adem√°s el 2 de febrero es mi cumplea√±os. Me record√°is a los Piratas y los Piratas me encantan. Estar√© pendientes de vosotros y espero veros pronto en alg√∫n directo. Muchas gracias por hacer m√∫sica y un abrazo muy grande para todos .","Grand√≠sima Canci√≥n. !!!"] => {"country":"Espa√±a","state":null,"city":null,"typeUser":"fan"}

 Ejemplo 4 (typeUser: null)
["Hola\nSimplemente me sali√≥ vuestra versi√≥n de Zorra y ya os he empezado a seguir üòú","Me gust√≥ pero si soy sincera no he podido de momento escuchar nada m√°s vuestro","Pues entonces os conocen en casa porque son todos eurofanes menos yoüòÖ","Si os hab√©is presentado al Benidorm fest","Pues os voy escuchando ‚ò∫Ô∏è","Aaahj","Eso est√° hecho üëçüèº","ü§£","Dar√© mi opini√≥n sincera"] => {"country":"Espa√±a","state":null,"city":null,"typeUser":null}

  Discriminar entre fan, superfan y null, depende de lo que interpretes en la conversaci√≥n. Si hay un √°nimo de ir a vernos, se le ve emocionado/a, hay muchos mensajes... pueden ser indicativos de ser un superfan. Si hay pocos mensajes, la conversaci√≥n es escueta pero nos dicen de donde son... podr√≠a considerarse fan. Si los mensajes son secantes, typeUser ser√° null. Tambi√©n tener en cuenta que existe un festival llamado Benidorm fest, esto no quiere decir que la persona sea de Benidorm. Debes de ser capaz de discriminar la ciudad y la provincia sin tener en cuenta este dato. Si alguna vez detectas una ciudad, siempre escribe el estado. Por ejemplo, si te dice que es de Tudela, state ser√≠a Navarra y city ser√≠a Tudela. Si no hay ciudad, state puede ir relleno si existe una provincia con ese nombre (o una comunidad aut√≥noma) y city ser√≠a null. Si no hay nada, state ser√≠a null y city ser√≠a null.

  Y sobre todo, si la conclusi√≥n a la que llegas cuando devuelvas los datos es que state y city son Unknown o null, nunca jam√°s typeUser podr√° ser ni fan ni superfan. MUY IMPORTANTE.  Siempre a la hora de determinar la procedencia (country o city), a no ser que sea de forma expl√≠cita primar√° el state. Si infieres que la persona es de Madrid en el campo state, el campo country nunca podr√° ser Qatar, ni la ciudad Doha. El country ser√° Espa√±a y la ciudad Madrid.
  Cualquier campo Unknown lo conviertes a null en la respuesta.

	Y ahora devuelveme tu el objeto que te ped√≠ en base a estos datos:
	`,
  USER: `En base a estos dos campos que te voy a pasar, y teniendo en cuenta estos ejemplos que te env√≠o, devuelve el nombre de pila m√°s posible para el usuario. 
	Quiero que devuelvas dos campos, el nombre de pila (short_name) y el tipo de usuario (treatment): (si crees que es una persona, treament = 1 y si crees que es un colectivo o indeterminado, treatment: 2. Devuelve √∫nicamente en una l√≠nea lo que consideres, en formato json: {username:, full_name:, short_name:, treament:}. A continuaci√≥n te env√≠o unos ejemplos, y luego infiere t√∫ el nombre:
	Ejemplo 1: {full_name: "Paty Palosamigos", username: "patypalosamigos"} => {username: "patypalosamigos", full_name: "Paty Palosamigos", short_name: "Paty", treatment: 1}
	Ejemplo 2: {full_name: "üì∏üé¨üáØ üá¥ üá∏ üá™ üá± üá∫üì∏üé¨This is magic", username: "joselu005"} => {username: "joselu005", full_name: "üì∏üé¨üáØ üá¥ üá∏ üá™ üá± üá∫üì∏üé¨This is magic", short_name: "Joselu", treatment: 1}
	Ejemplo 3: {full_name: "Eva A. ‚ö°Ô∏è", username: "entrelucesyacordes"} => {username: "entrelucesyacordes", full_name: "Eva A. ‚ö°Ô∏è", short_name: "Eva", treatment: 1}
	Ejemplo 4: {full_name: "", username: "mumy_08"} => {username: "mumy_08", full_name: "", short_name: "Mumy", treatment: 1}
	Ejemplo 5: {full_name: "Saca tu foie", username: "saca_tu_foie"} => {username: "saca_tu_foie", full_name: "Saca tu foie", short_name: "Saca tu foie", treatment: 2}
	Ejemplo 6: {full_name: "¬©a¬Æmen", username: "carmenjorquera33"} => {username: "carmenjorquera33", full_name: "¬©a¬Æmen", short_name: "Carmen", treatment: 1}
	Ejemplo 7: {full_name: "…ë”Ä“Ω’µ…ë’≤’™…æ…ë", username: "godellaesbella"} => {username: "godellaesbella", full_name: "…ë”Ä“Ω’µ…ë’≤’™…æ…ë", short_name: "Alejandra", treatment: 1}
	Ejemplo 8: {full_name: "‚Ñùùïíùïîùïôùïñùïñùïñùïñùïù", username: "bass_rpm"} => {username: "‚Ñùùïíùïîùïôùïñùïñùïñùïñùïù", full_name: "bass_rpm", short_name: "Rachel", treatment: 1}
	Ejemplo 9: {full_name: "üÖ∞üÖªüÖª üÜÇüÖæüÜÑüÖΩüÖ≥üÜÇ", username: "allsoundspromo"} => {username: "allsoundspromo", full_name: "üÖ∞üÖªüÖª üÜÇüÖæüÜÑüÖΩüÖ≥üÜÇ", short_name: "All Sounds", treatment: 2}
	Ejemplo 10: {full_name: "NSPECIAL MUSIC", username: "nspecialmusic"} => {username: "nspecialmusic", full_name: "NSPECIAL MUSIC", short_name: "Nspecial", treatment: 2}
	Ejemplo 11: {full_name: "yo", username: "lydi2m"} => {username: "lydi2n", full_name: "yo", short_name: "Lydia", treatment: 1}

	Y ahora sigue tu en base a estos datos:
	`,
};

/**
 * Gemini service
 */
export const geminiSvc: any = {
  models: [
    "gemini-2.0-flash",
    "gemini-2.5-flash",
    "gemini-2.5-flash-lite",
    "gemini-2.5-flash-lite",
  ],

  currentModel: null,

  setCurrentModel: () => {
    if (!geminiSvc.currentModel) {
      const index = Math.floor(Math.random() * geminiSvc.models.length);
      geminiSvc.currentModel = geminiSvc.models[index];
    } else {
      const currentIndex = geminiSvc.models.indexOf(geminiSvc.currentModel);
      const nextIndex = (currentIndex + 1) % geminiSvc.models.length;
      geminiSvc.currentModel = geminiSvc.models[nextIndex];
    }
  },

  ask: async (question: string) => {
    if (!geminiSvc.currentModel) {
      geminiSvc.setCurrentModel();
    }
    const response = await ai.models.generateContent({
      model: geminiSvc.currentModel,
      contents: question,
    });
    return response.candidates?.[0]?.content;
  },

  getUserInfo: async (data: string) => {
    const response = await geminiSvc.ask(`${QUESTIONS.INFO} ${data}`);
    try {
      return (
        JSON.parse(
          response.parts?.[0]?.text
            .trim()
            .replace(/```json/, "")
            .replace(/```/, "")
            .trim()
        ) ?? {}
      );
    } catch (error) {
      console.error("Error en getUserInfo:", response);
      return {};
    }
  },

  getUserData: async (data: string) => {
    const response = await geminiSvc.ask(`${QUESTIONS.USER} ${data}`);
    return JSON.parse(response.parts?.[0]?.text.replace(/```json/, "").replace(/```/, "")) ?? {};
  },
};
